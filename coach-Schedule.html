<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ•™ç·´æ’ç¨‹ç³»çµ± v2.3 å»é‡ä¿®å¾©ç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --green: #7ac19a;
            --green-light: #e2ede6;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --pink-dark: #c67566;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --yellow-dark: #ba9e60;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --blue-dark: #66888e;
            --white: #ffffff;
            --gray: #808080;
            --bg: #f8f9fa;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --orange: #ff9800;
            --orange-light: #fff3e0;
            --purple: #9966cc;
            --purple-light: #f0e6ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y;
        }
        
        button, a, .slot-cell, .week-btn, .action-btn, .stat-card {
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-dark);
            line-height: 1.6;
            padding-bottom: 20px;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--green-light), var(--pink-light));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--green-light);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .navbar {
            background: linear-gradient(135deg, var(--green-light), var(--pink-light), var(--yellow-light));
            padding: 16px 20px;
            box-shadow: var(--shadow-sm);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--green), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            box-shadow: var(--shadow-md);
            flex-shrink: 0;
        }

        .user-info h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 3px;
        }

        .user-info p {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 1px;
        }

        .container {
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .stat-card {
            flex: 1;
            min-width: 90px;
            background: var(--white);
            border-radius: 8px;
            padding: 12px 8px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 8px 8px 0 0;
        }

        .stat-card.green::before { background: var(--green); }
        .stat-card.orange::before { background: var(--orange); }
        .stat-card.pink::before { background: var(--pink); }
        .stat-card.yellow::before { background: var(--yellow); }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-card:active {
            transform: translateY(0);
        }

        .stat-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
        }

        .detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .detail-modal.hidden {
            display: none;
        }

        .detail-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .detail-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--green-light);
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-radius: 16px 16px 0 0;
        }

        .detail-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-modal-subtitle {
            font-size: 14px;
            color: var(--text-light);
        }

        .detail-modal-body {
            padding: 20px;
        }

        .detail-slot-group {
            margin-bottom: 16px;
        }

        .detail-slot-date {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 8px;
            font-size: 14px;
        }

        .detail-slot-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding-left: 12px;
        }

        .detail-slot-item {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .detail-slot-item.confirmed {
            background: var(--green-light);
            color: var(--green-dark);
            border: 1px solid var(--green);
        }

        .detail-slot-item.pending {
            background: var(--orange-light);
            color: var(--orange);
            border: 1px dashed var(--orange);
        }

        .detail-slot-item.booked {
            background: var(--pink-light);
            color: var(--pink-dark);
            border: 1px solid var(--pink);
        }

        .detail-slot-item.reserved {
            background: var(--yellow-light);
            color: var(--yellow-dark);
            border: 1px solid var(--yellow);
        }

        .detail-slot-item.optimistic {
            position: relative;
            animation: pulse-optimistic 2s infinite;
        }

        .detail-slot-item.optimistic::after {
            content: 'å¾…é€å‡º';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 9px;
            background: var(--orange);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        @keyframes pulse-optimistic {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .detail-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .detail-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .detail-modal-footer {
            padding: 20px;
            border-top: 1px solid var(--green-light);
            position: sticky;
            bottom: 0;
            background: white;
            border-radius: 0 0 16px 16px;
        }

        .detail-close-btn {
            width: 100%;
            padding: 14px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .detail-close-btn:hover {
            background: var(--green-dark);
        }

        .week-selector {
            background: var(--white);
            border-radius: 12px 12px 0 0;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 12px;
        }
        
        .week-selector > div:first-child {
            flex-shrink: 0;
            min-width: 120px;
            order: 0 !important;
        }
        
        .week-nav {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            order: 1 !important;
        }
        
        @media (max-width: 480px) {
            .week-selector {
                flex-direction: column !important;
                align-items: stretch !important;
            }
            
            .week-selector > div:first-child {
                order: 2 !important;
                margin-top: 12px !important;
            }
            
            .week-nav {
                order: 1 !important;
            }
        }

        .week-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--green-light);
            color: var(--green-dark);
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .week-btn:hover {
            background: var(--green);
            color: white;
        }

        .week-display {
            flex: 1;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 8px;
        }

        .week-display:hover {
            background: var(--green-light);
        }

        .week-date {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .week-range {
            font-size: 13px;
            color: var(--text-light);
        }

        .schedule-grid {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            position: relative;
            min-height: 400px;
        }

        .day-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 8px;
            padding: 16px;
            background: #ffffff;
            z-index: 50;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .schedule-header-sticky {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg);
            margin-bottom: 16px;
        }
        
        .schedule-container {
            position: relative;
            margin-bottom: 16px;
        }

        .day-label {
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
            padding: 8px 4px;
        }

        .day-label.today {
            color: var(--purple);
            font-weight: 700;
            background: linear-gradient(135deg, #f8f4ff, var(--purple-light));
            border-radius: 8px;
            position: relative;
            border: 2px solid #c299ff;
            box-shadow: 0 0 12px rgba(153, 102, 204, 0.25);
        }

        .day-label.today::before {
            content: 'ğŸ“';
            position: absolute;
            top: -10px;
            right: 0px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        @keyframes highlight {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 20px rgba(122, 193, 154, 0.8); transform: scale(1.05); }
        }

        .day-label.today .day-date {
            color: var(--purple);
            font-weight: 700;
        }

        .day-date {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .time-row {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .time-label {
            font-size: 13px;
            color: var(--text-light);
            padding: 12px 4px;
            text-align: center;
            font-weight: 500;
        }

        .slot-cell {
            min-height: 70px;
            border: 2px solid var(--green-light);
            border-radius: 8px;
            cursor: pointer;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            touch-action: manipulation;
            user-select: none;
        }
        
        .slot-time {
            font-size: 13px;
            font-weight: 600;
            color: #d0d0d0;
        }

        .slot-cell:hover {
            border-color: var(--green);
            background: var(--green-light);
        }

        .slot-cell.confirmed {
            background: var(--green-light);
            border-color: var(--green);
        }

        .slot-cell.confirmed.optimistic {
            position: relative;
            animation: pulse-optimistic 2s infinite;
        }

        .slot-cell.confirmed.optimistic::before {
            content: 'å¾…é€å‡º';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 9px;
            background: var(--orange);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
            z-index: 1;
        }

        .slot-cell.pending {
            background: var(--orange-light);
            border-color: var(--orange);
            border-style: dashed;
        }

        .slot-cell.pending::after {
            content: 'ğŸ“';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
        }

        .slot-cell.booked {
            background: var(--pink-light);
            border-color: var(--pink);
            cursor: not-allowed;
            flex-direction: column;
            gap: 4px;
        }

        .slot-cell.booked::after {
            content: '';
        }

        .slot-cell.booked .slot-time {
            color: var(--pink-dark);
        }

        .slot-cell.booked .student-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--pink-dark);
        }

        .slot-cell.reserved {
            background: var(--yellow-light);
            border-color: var(--yellow);
            cursor: not-allowed;
            flex-direction: column;
            gap: 4px;
        }

        .slot-cell.reserved::after {
            content: 'â±';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
        }

        .slot-cell.reserved .slot-time {
            color: var(--yellow-dark);
        }

        .slot-cell.reserved .student-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--yellow-dark);
        }

        .legend {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-dark);
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .legend-box.confirmed {
            background: var(--green-light);
            border: 2px solid var(--green);
        }

        .legend-box.pending {
            background: var(--orange-light);
            border: 2px dashed var(--orange);
        }

        .legend-box.booked {
            background: var(--pink-light);
            border: 2px solid var(--pink);
        }

        .legend-box.reserved {
            background: var(--yellow-light);
            border: 2px solid var(--yellow);
        }

        .legend-text {
            font-size: 13px;
            color: var(--text-dark);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .action-buttons .btn-primary {
            grid-column: 1 / -1;
        }

        .action-btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:hover {
            background: var(--green-dark);
        }

        .btn-primary:disabled {
            background: var(--gray);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid var(--green-light);
        }

        .btn-secondary:hover {
            border-color: var(--green);
            background: var(--green-light);
        }

        .btn-danger {
            background: var(--white);
            color: var(--pink-dark);
            border: 2px solid var(--pink-light);
        }

        .btn-danger:hover {
            border-color: var(--pink);
            background: var(--pink-light);
        }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--green-light);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .modal-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
        }

        .modal-stat-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .modal-stat-number.add { color: var(--green); }
        .modal-stat-number.delete { color: var(--pink); }
        .modal-stat-number.total { color: var(--text-dark); }

        .modal-stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .modal-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .schedule-item.add {
            background: var(--green-light);
            border-left: 3px solid var(--green);
        }

        .schedule-item.delete {
            background: var(--pink-light);
            border-left: 3px solid var(--pink);
        }

        .schedule-date {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .schedule-time {
            font-size: 13px;
            color: var(--text-light);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--green-light);
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-cancel {
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid var(--green-light);
        }

        .modal-btn-cancel:hover {
            border-color: var(--green);
        }

        .modal-btn-confirm {
            background: var(--green);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: var(--green-dark);
        }

        .modal-btn-confirm:disabled {
            background: var(--gray);
            cursor: not-allowed;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }

            .schedule-grid {
                padding: 8px;
            }

            .slot-cell {
                min-height: 55px;
                font-size: 13px;
            }

            .time-label {
                font-size: 11px;
            }

            .day-label {
                font-size: 12px;
            }
            
            .day-header {
                gap: 4px;
                padding: 8px;
                grid-template-columns: 50px repeat(7, 1fr);
            }
            
            .time-row {
                grid-template-columns: 50px repeat(7, 1fr);
                gap: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">è¼‰å…¥æ’ç¨‹è³‡æ–™ä¸­...</div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="navbar">
            <div class="user-profile">
                <div class="avatar" id="userAvatar">ğŸ‘¤</div>
                <div class="user-info">
                    <div style="font-size: 10px; color: var(--text-light); letter-spacing: 0.5px; margin-bottom: 2px; text-transform: uppercase;">æ•™ç·´æ’ç¨‹ç³»çµ± v2.3 å»é‡ä¿®å¾©ç‰ˆ</div>
                    <h1 id="userName">æ•™ç·´å§“å</h1>
                    <p id="userType">æ•™ç·´é¡å‹</p>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="schedule-container">
                <div class="schedule-header-sticky">
                    <div class="week-selector">
                        <div style="display: flex; flex-direction: column; align-items: stretch; gap: 4px;">
                            <button class="action-btn btn-secondary" onclick="toggleViewMode()" id="viewModeBtn">
                                ğŸ¯ è©³ç´°æ¨¡å¼
                            </button>
                            <div style="text-align: center; font-size: 10px; color: var(--text-light); line-height: 1.2;" id="viewModeDesc">
                                åˆ‡æ›å¯é¸15/30/45åˆ†
                            </div>
                        </div>
                        <div class="week-nav">
                            <button class="week-btn" onclick="previousWeek()">â—€</button>
                            <div class="week-display" onclick="showWeekJumpModal()">
                                <div class="week-date" id="weekDisplay">ç¬¬ 1 é€±</div>
                                <div class="week-range" id="weekRange">2024/01/01 - 2024/01/07</div>
                                <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">é»æ“Šå¿«é€Ÿè·³è½‰</div>
                            </div>
                            <button class="week-btn" onclick="nextWeek()">â–¶</button>
                        </div>
                    </div>
                    <div class="day-header" id="dayHeader"></div>
                </div>

                <div class="schedule-grid">
                    <div class="time-table" id="timeTable"></div>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card green" onclick="showSlotDetails('confirmed')">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-number" id="statConfirmed">0</div>
                    <div class="stat-label">å·²ç¢ºèª</div>
                </div>
                <div class="stat-card orange" onclick="showSlotDetails('pending')">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-number" id="statPending">0</div>
                    <div class="stat-label">å¾…é€å‡º</div>
                </div>
                <div class="stat-card pink" onclick="showSlotDetails('booked')">
                    <div class="stat-icon">ğŸ”’</div>
                    <div class="stat-number" id="statBooked">0</div>
                    <div class="stat-label">å·²é ç´„</div>
                </div>
                <div class="stat-card yellow" onclick="showSlotDetails('reserved')">
                    <div class="stat-icon">â±</div>
                    <div class="stat-number" id="statReserved">0</div>
                    <div class="stat-label">ä¿ç•™ä¸­</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="showSaveModal()" id="saveBtn">
                    âœ”ï¸ é€å‡ºæ’ç¨‹
                </button>
                <button class="action-btn btn-secondary" onclick="reloadFromCalendar()">
                    ğŸ”„ é‡æ–°è¼‰å…¥
                </button>
                <button class="action-btn btn-secondary" onclick="copyLastWeek()">
                    ğŸ“‹ è¤‡è£½ä¸Šé€±
                </button>
                <button class="action-btn btn-danger" onclick="clearCurrentWeek()">
                    ğŸ—‘ï¸ æ¸…é™¤æœ¬é€±
                </button>
                <button class="action-btn btn-danger" onclick="clearAllWeeks()">
                    ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨
                </button>
            </div>

            <div class="legend">
                <div class="legend-title">ğŸ“‹ æ™‚æ®µç‹€æ…‹èªªæ˜</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-box confirmed"></div>
                        <span class="legend-text">å·²ç¢ºèª</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box pending"></div>
                        <span class="legend-text">å¾…é€å‡º</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box booked"></div>
                        <span class="legend-text">å·²é ç´„</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box reserved"></div>
                        <span class="legend-text">ä¿ç•™ä¸­</span>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding: 12px; background: var(--purple-light); border-radius: 8px; border-left: 4px solid var(--purple);">
                    <div style="font-weight: 600; margin-bottom: 4px;">ğŸ’¡ v2.3 ä¿®å¾©èªªæ˜</div>
                    <div style="font-size: 13px; color: var(--text-dark);">
                        â€¢ âœ… ä¿®å¾©é‡è¤‡é€å‡ºå•é¡Œ - åŠ å…¥å»é‡é‚è¼¯<br>
                        â€¢ âœ… ä¿®å¾©å¿«é€Ÿé»æ“Šå•é¡Œ - åŠ å…¥ 300ms é˜²æŠ–<br>
                        â€¢ âœ… ä¿®å¾©è¤‡è£½ä¸Šé€±é‡è¤‡ - åŒæ™‚æª¢æŸ¥ pending
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´°æ™‚æ®µå½ˆçª— -->
    <div class="detail-modal hidden" id="detailModal">
        <div class="detail-modal-content">
            <div class="detail-modal-header">
                <div class="detail-modal-title">
                    <span id="detailModalIcon">âœ…</span>
                    <span id="detailModalTitle">å·²ç¢ºèªæ™‚æ®µ</span>
                </div>
                <div class="detail-modal-subtitle" id="detailModalSubtitle">å…± 0 å€‹æ™‚æ®µ</div>
            </div>
            <div class="detail-modal-body" id="detailModalBody"></div>
            <div class="detail-modal-footer">
                <button class="detail-close-btn" onclick="hideSlotDetails()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªé€å‡ºå½ˆçª— -->
    <div class="modal-overlay hidden" id="saveModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ç¢ºèªé€å‡ºæ’ç¨‹</div>
                <div class="modal-subtitle">è«‹ç¢ºèªä»¥ä¸‹è®Šæ›´å…§å®¹</div>
            </div>
            <div class="modal-body">
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-number add" id="modalAddCount">0</div>
                        <div class="modal-stat-label">æ–°å¢æ™‚æ®µ</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number delete" id="modalDeleteCount">0</div>
                        <div class="modal-stat-label">åˆªé™¤æ™‚æ®µ</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number total" id="modalTotalCount">0</div>
                        <div class="modal-stat-label">ç¸½è¨ˆæ™‚æ®µ</div>
                    </div>
                </div>
                <div class="modal-list" id="confirmScheduleList"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="hideSaveModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmSave()" id="confirmSaveBtn">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿè·³è½‰é€±æ¬¡å½ˆçª— -->
    <div class="modal-overlay hidden" id="weekJumpModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ—“ï¸ å¿«é€Ÿè·³è½‰é€±æ¬¡</div>
                <div class="modal-subtitle">é¸æ“‡è¦è·³è½‰çš„æ—¥æœŸ</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">é¸æ“‡æ—¥æœŸ</label>
                    <input type="date" id="jumpToDate" style="width: 100%; padding: 12px; border: 2px solid var(--green-light); border-radius: 8px; font-size: 16px;"/>
                </div>
                <div style="background: var(--green-light); padding: 12px; border-radius: 8px; font-size: 13px;">
                    ğŸ’¡ ç³»çµ±æœƒè‡ªå‹•è·³è½‰åˆ°é¸æ“‡æ—¥æœŸæ‰€åœ¨çš„é€±æ¬¡(é€±ä¸€é–‹å§‹)
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="hideWeekJumpModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmWeekJump()">ç¢ºèªè·³è½‰</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) event.preventDefault();
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) event.preventDefault();
            lastTouchEnd = now;
        }, { passive: false });

        const TEST_MODE = false;
        const WEBHOOK_URL = 'https://hook.us2.make.com/ykptxvohkcxrbjf91s8uqggh2pfhtmr5';
        const CALENDAR_LOAD_URL = 'https://hook.us2.make.com/ykptxvohkcxrbjf91s8uqggh2pfhtmr5';
        const PRELOAD_WEEKS = 10;
        
        let currentTeacher = '';
        let currentTeacherType = '';
        let currentWeekStart = new Date();
        let currentWeekEnd = new Date();
        let calendarData = {};
        let pendingChanges = {};
        let viewMode = 'simple';
        let baseWeekStart = null;
        let isSaving = false;
        let isToggling = false;  // âœ… æ–°å¢ï¼šé˜²æ­¢å¿«é€Ÿé»æ“Š
        
        const timeSlotsSimple = ['06:00', '07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'];
        const timeSlotsDetail = ['06:00', '06:15', '06:30', '06:45', '07:00', '07:15', '07:30', '07:45', '08:00', '08:15', '08:30', '08:45', '09:00', '09:15', '09:30', '09:45', '10:00', '10:15', '10:30', '10:45', '11:00', '11:15', '11:30', '11:45', '12:00', '12:15', '12:30', '12:45', '13:00', '13:15', '13:30', '13:45', '14:00', '14:15', '14:30', '14:45', '15:00', '15:15', '15:30', '15:45', '16:00', '16:15', '16:30', '16:45', '17:00', '17:15', '17:30', '17:45', '18:00', '18:15', '18:30', '18:45', '19:00', '19:15', '19:30', '19:45', '20:00', '20:15', '20:30', '20:45', '21:00', '21:15', '21:30', '21:45', '22:00', '22:15', '22:30', '22:45', '23:00', '23:15', '23:30', '23:45'];
        const dayLabels = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];

        function calculateEndTimeAndDate(dateStr, startTime, durationMinutes = 60) {
            const startDateTime = new Date(`${dateStr}T${startTime}:00`);
            const endDateTime = new Date(startDateTime);
            endDateTime.setMinutes(endDateTime.getMinutes() + durationMinutes);
            
            const endYear = endDateTime.getFullYear();
            const endMonth = String(endDateTime.getMonth() + 1).padStart(2, '0');
            const endDay = String(endDateTime.getDate()).padStart(2, '0');
            const endDate = `${endYear}-${endMonth}-${endDay}`;
            
            const endHour = String(endDateTime.getHours()).padStart(2, '0');
            const endMinute = String(endDateTime.getMinutes()).padStart(2, '0');
            const endTime = `${endHour}:${endMinute}`;
            
            return {
                endDate,
                endTime,
                endDateTime: `${endDate} ${endTime}`,
                isCrossDay: dateStr !== endDate
            };
        }

        function updateSaveStatus() {
            const saveBtn = document.getElementById('saveBtn');
            
            let totalPending = 0;
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey]) {
                    totalPending += pendingChanges[weekKey].length;
                }
            });
            
            if (totalPending > 0) {
                saveBtn.disabled = false;
            } else {
                saveBtn.disabled = true;
            }
        }

        async function init() {
            try {
                console.log('ğŸš€ ç³»çµ±åˆå§‹åŒ– v2.3 å»é‡ä¿®å¾©ç‰ˆ');
                resetStats();
                await getUserInfo();
                setCurrentWeek();
                updateWeekDisplay();
                
                calendarData = {};
                pendingChanges = {};
                
                await loadFromCalendar();
                generateCalendar();
                updateStats();
                updateSaveStatus();
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('show');
                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                showToast('âŒ è¼‰å…¥å¤±æ•—');
            }
        }

        function resetStats() {
            console.log('ğŸ”„ é‡ç½®çµ±è¨ˆæ•¸å­—ç‚º 0');
            document.getElementById('statConfirmed').textContent = '0';
            document.getElementById('statPending').textContent = '0';
            document.getElementById('statBooked').textContent = '0';
            document.getElementById('statReserved').textContent = '0';
        }

        async function loadFromCalendar(startDate = null, endDate = null) {
            try {
                if (!startDate) startDate = new Date(currentWeekStart);
                if (!endDate) {
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (PRELOAD_WEEKS * 7));
                }
                
                console.log(`ğŸ“… è¼‰å…¥: ${formatDate(startDate)} ~ ${formatDate(endDate)}`);
                showToast(`ğŸ“¥ è¼‰å…¥ ${PRELOAD_WEEKS} é€±è³‡æ–™...`);
                
                if (TEST_MODE) {
                    calendarData = {};
                    pendingChanges = {};
                    showToast('âœ… æ¸¬è©¦æ¨¡å¼');
                    return;
                }
                
                const response = await fetch(CALENDAR_LOAD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'load',
                        userId: currentTeacher,
                        coachType: currentTeacherType,
                        startDate: formatDate(startDate),
                        endDate: formatDate(endDate)
                    })
                });

                if (response.ok) {
                    const responseText = await response.text();
                    
                    console.log('ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™');
                    calendarData = {};
                    pendingChanges = {};
                    resetStats();
                    
                    if (!responseText || responseText === 'Accepted' || responseText === 'OK' || responseText.trim() === '') {
                        console.log('âœ… è¼‰å…¥å®Œæˆ (ç„¡è³‡æ–™)');
                        showToast('âœ… è¼‰å…¥å®Œæˆ (ç›®å‰ç„¡æ’ç¨‹)');
                        return;
                    }
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        console.error('âŒ JSONè§£æå¤±æ•—:', e);
                        showToast('âŒ è³‡æ–™æ ¼å¼éŒ¯èª¤');
                        return;
                    }
                    
                    const newData = processCalendarData(data);
                    Object.keys(newData).forEach(weekKey => {
                        calendarData[weekKey] = newData[weekKey];
                    });
                    
                    const totalEvents = Object.values(calendarData).reduce((sum, arr) => sum + arr.length, 0);
                    console.log(`âœ… è¼‰å…¥ ${totalEvents} å€‹æ™‚æ®µ`);
                    showToast(`âœ… è¼‰å…¥ ${totalEvents} å€‹æ™‚æ®µ`);
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥å¤±æ•—:', error);
                calendarData = {};
                pendingChanges = {};
                resetStats();
                showToast('âŒ è¼‰å…¥å¤±æ•—');
            }
        }

        function processCalendarData(data) {
            const processed = {};
            const eventList = data?.events || data?.schedules || [];
            
            console.log(`ğŸ“‹ åŸå§‹è³‡æ–™: ${eventList.length} å€‹äº‹ä»¶`);
            
            // âœ… æ–°å¢ï¼šç”¨æ–¼å»é‡çš„ Set
            const seenKeys = new Set();
            
            if (eventList && eventList.length > 0) {
                eventList.forEach((event, index) => {
                    if (!event || typeof event !== 'object') {
                        console.warn(`âš ï¸ è·³éç„¡æ•ˆäº‹ä»¶ #${index}:`, event);
                        return;
                    }
                    
                    if (!event.date || !event.startTime || !event.endTime) {
                        console.warn(`âš ï¸ è·³éä¸å®Œæ•´äº‹ä»¶ #${index}:`, event);
                        return;
                    }
                    
                    if (typeof event.date !== 'string' || 
                        typeof event.startTime !== 'string' || 
                        typeof event.endTime !== 'string') {
                        console.warn(`âš ï¸ è·³éå‹åˆ¥éŒ¯èª¤äº‹ä»¶ #${index}:`, event);
                        return;
                    }
                    
                    let eventDate = event.date;
                    if (eventDate.includes('/')) {
                        eventDate = eventDate.replace(/\//g, '-');
                    }
                    
                    // âœ… æ–°å¢ï¼šå»é‡æª¢æŸ¥
                    const uniqueKey = `${eventDate}_${event.startTime}_${event.endTime}`;
                    if (seenKeys.has(uniqueKey)) {
                        console.warn(`âš ï¸ è·³éé‡è¤‡äº‹ä»¶: ${uniqueKey}`);
                        return;
                    }
                    seenKeys.add(uniqueKey);
                    
                    let studentName = event.studentName || event.memberName || '';
                    if (studentName && typeof studentName === 'string') {
                        studentName = studentName
                            .replace(/\)/g, '')
                            .replace(/\(/g, '')
                            .replace(/\[/g, '')
                            .replace(/\]/g, '')
                            .trim();
                        
                        if (studentName === 'null' || studentName === 'undefined') {
                            studentName = '';
                        }
                    }
                    
                    const weekKey = getWeekKeyFromDate(eventDate);
                    if (!processed[weekKey]) processed[weekKey] = [];
                    
                    processed[weekKey].push({
                        date: eventDate,
                        startTime: event.startTime,
                        endTime: event.endTime,
                        status: event.status || 'available',
                        eventId: event.eventId || event.id,
                        studentName: studentName,
                        optimistic: false
                    });
                });
            }
            
            const validCount = Object.values(processed).reduce((sum, arr) => sum + arr.length, 0);
            console.log(`âœ… è™•ç†å®Œæˆ: ${validCount} å€‹æœ‰æ•ˆæ™‚æ®µ (å»é‡å¾Œ)`);
            
            return processed;
        }

        function updateStats() {
            let confirmed = 0, pending = 0, booked = 0, reserved = 0;
            
            console.log('ğŸ“Š é–‹å§‹çµ±è¨ˆ (v2.3 å»é‡ä¿®å¾©ç‰ˆ)');
            
            const toBeDeleted = new Set();
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey]) {
                    pendingChanges[weekKey].forEach(change => {
                        if (change.action === 'delete') {
                            toBeDeleted.add(`${change.date}_${change.startTime}_${change.endTime}`);
                        }
                        pending++;
                    });
                }
            });
            
            if (calendarData && typeof calendarData === 'object') {
                Object.keys(calendarData).forEach(weekKey => {
                    const weekData = calendarData[weekKey];
                    
                    if (!weekData || !Array.isArray(weekData) || weekData.length === 0) {
                        return;
                    }
                    
                    weekData.forEach(e => {
                        if (!e || typeof e !== 'object' || !e.status || typeof e.status !== 'string') {
                            console.warn('âš ï¸ è·³éç„¡æ•ˆæ™‚æ®µ:', e);
                            return;
                        }
                        
                        if (!e.date || !e.startTime || !e.endTime) {
                            console.warn('âš ï¸ è·³éä¸å®Œæ•´æ™‚æ®µ:', e);
                            return;
                        }
                        
                        const key = `${e.date}_${e.startTime}_${e.endTime}`;
                        
                        if (e.status === 'available' && !e.optimistic && !toBeDeleted.has(key)) {
                            confirmed++;
                        } else if (e.status === 'booked') {
                            booked++;
                        } else if (e.status === 'reserved') {
                            reserved++;
                        }
                    });
                });
            }
            
            console.log('ğŸ“Š çµ±è¨ˆçµæœ:', { confirmed, pending, booked, reserved });
            
            document.getElementById('statConfirmed').textContent = confirmed.toString();
            document.getElementById('statPending').textContent = pending.toString();
            document.getElementById('statBooked').textContent = booked.toString();
            document.getElementById('statReserved').textContent = reserved.toString();
            
            console.log('âœ… çµ±è¨ˆæ›´æ–°å®Œæˆ');
        }

        function showSlotDetails(type) {
            const typeConfig = {
                confirmed: { title: 'å·²ç¢ºèªæ™‚æ®µ', icon: 'âœ…', class: 'confirmed', status: 'available' },
                pending: { title: 'å¾…é€å‡ºæ™‚æ®µ', icon: 'ğŸ“', class: 'pending', isPending: true },
                booked: { title: 'å·²é ç´„æ™‚æ®µ', icon: 'ğŸ”’', class: 'booked', status: 'booked' },
                reserved: { title: 'ä¿ç•™ä¸­æ™‚æ®µ', icon: 'â±', class: 'reserved', status: 'reserved' }
            };
            
            const config = typeConfig[type];
            const slots = [];
            
            if (config.isPending) {
                const slotKeys = new Set();
                
                Object.keys(pendingChanges).forEach(weekKey => {
                    if (pendingChanges[weekKey] && Array.isArray(pendingChanges[weekKey])) {
                        pendingChanges[weekKey].forEach(change => {
                            if (change && change.date && change.startTime && change.endTime) {
                                const key = `${change.date}_${change.startTime}_${change.endTime}`;
                                
                                if (!slotKeys.has(key)) {
                                    slotKeys.add(key);
                                    
                                    slots.push({
                                        date: change.date,
                                        startTime: change.startTime,
                                        endTime: change.endTime,
                                        action: change.action,
                                        optimistic: change.action === 'add' && calendarData[weekKey]?.some(e =>
                                            e.date === change.date &&
                                            e.startTime === change.startTime &&
                                            e.endTime === change.endTime &&
                                            e.optimistic
                                        )
                                    });
                                }
                            }
                        });
                    }
                });
            } else {
                Object.keys(calendarData).forEach(weekKey => {
                    if (calendarData[weekKey] && Array.isArray(calendarData[weekKey])) {
                        calendarData[weekKey].forEach(event => {
                            if (event && 
                                typeof event === 'object' && 
                                event.status === config.status &&
                                event.date &&
                                event.startTime &&
                                event.endTime &&
                                !event.optimistic) {
                                slots.push({
                                    date: event.date,
                                    startTime: event.startTime,
                                    endTime: event.endTime,
                                    studentName: event.studentName || event.memberName || ''
                                });
                            }
                        });
                    }
                });
            }
            
            document.getElementById('detailModalIcon').textContent = config.icon;
            document.getElementById('detailModalTitle').textContent = config.title;
            document.getElementById('detailModalSubtitle').textContent = `å…± ${slots.length} å€‹æ™‚æ®µ`;
            
            const modalBody = document.getElementById('detailModalBody');
            
            if (slots.length === 0) {
                modalBody.innerHTML = `
                    <div class="detail-empty">
                        <div class="detail-empty-icon">${config.icon}</div>
                        <div>ç›®å‰æ²’æœ‰${config.title}</div>
                    </div>
                `;
            } else {
                const slotsByDate = {};
                slots.forEach(slot => {
                    if (!slotsByDate[slot.date]) slotsByDate[slot.date] = [];
                    slotsByDate[slot.date].push(slot);
                });
                
                const sortedDates = Object.keys(slotsByDate).sort();
                
                modalBody.innerHTML = sortedDates.map(date => {
                    const dateSlots = slotsByDate[date].sort((a, b) => 
                        a.startTime.localeCompare(b.startTime)
                    );
                    
                    const dateObj = new Date(date + 'T00:00:00');
                    const dayOfWeek = dayLabels[dateObj.getDay() === 0 ? 6 : dateObj.getDay() - 1];
                    
                    return `
                        <div class="detail-slot-group">
                            <div class="detail-slot-date">
                                ${date} (${dayOfWeek})
                            </div>
                            <div class="detail-slot-list">
                                ${dateSlots.map(slot => `
                                    <div class="detail-slot-item ${config.class}${slot.optimistic ? ' optimistic' : ''}" onclick="jumpToSlot('${date}', '${slot.startTime}', event)" style="cursor: pointer;">
                                        ${slot.startTime} - ${slot.endTime}
                                        ${slot.studentName ? ` (${slot.studentName})` : ''}
                                        ${slot.action === 'delete' ? ' <span style="color: var(--pink);">âŒ</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function hideSlotDetails() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function jumpToSlot(dateStr, timeStr, event) {
            if (event) {
                event.stopPropagation();
            }
            
            hideSlotDetails();
            
            const targetDate = new Date(dateStr + 'T00:00:00');
            const dayOfWeek = targetDate.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            
            const weekStart = new Date(targetDate);
            weekStart.setDate(targetDate.getDate() + diff);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            currentWeekStart = weekStart;
            currentWeekEnd = weekEnd;
            
            const hasMinutes = timeStr.includes(':') && !timeStr.endsWith(':00');
            if (hasMinutes && viewMode === 'simple') {
                viewMode = 'detail';
                document.getElementById('viewModeBtn').innerHTML = 'âš¡ ç°¡æ˜“æ¨¡å¼';
                document.getElementById('viewModeDesc').textContent = 'åˆ‡æ›åªé¸"æ•´é»"æ™‚æ®µ';
                showToast('ğŸ¯ å·²åˆ‡æ›è‡³è©³ç´°æ¨¡å¼');
            }
            
            updateWeekDisplay();
            generateCalendar();
            updateStats();
            updateSaveStatus();
            
            setTimeout(() => {
                const timeSlots = getCurrentTimeSlots();
                const timeIndex = timeSlots.indexOf(timeStr);
                
                if (timeIndex !== -1) {
                    const dayIndex = targetDate.getDay() === 0 ? 6 : targetDate.getDay() - 1;
                    
                    const timeRows = document.querySelectorAll('.time-row');
                    if (timeRows[timeIndex]) {
                        const slotCells = timeRows[timeIndex].querySelectorAll('.slot-cell');
                        if (slotCells[dayIndex]) {
                            slotCells[dayIndex].scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                            
                            slotCells[dayIndex].style.animation = 'highlight 2s';
                        }
                    }
                }
                
                showToast(`ğŸ“ å·²è·³è½‰è‡³ ${dateStr} ${timeStr}`);
            }, 100);
        }

        function generateCalendar() {
            const timeSlots = getCurrentTimeSlots();
            
            const dayHeaderHtml = `
                <div class="day-label">æ™‚é–“</div>
                ${dayLabels.map((day, i) => {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + i);
                    return `<div class="day-label ${isDateToday(date) ? 'today' : ''}">${day}<div class="day-date">${formatDateShort(date)}</div></div>`;
                }).join('')}
            `;
            
            const tableHtml = timeSlots.map((time, timeIndex) => `
                <div class="time-row">
                    <div class="time-label">${time}</div>
                    ${[0, 1, 2, 3, 4, 5, 6].map(dayIndex => {
                        const slotInfo = getSlotInfo(dayIndex, timeIndex);
                        let content = `<span class="slot-time">${time}</span>`;
                        
                        if (slotInfo.studentName) {
                            const icon = slotInfo.class === 'booked' ? 'ğŸ”’' : 'â±';
                            content = `
                                <span class="slot-time">${time}</span>
                                <span class="student-name">${icon} ${slotInfo.studentName}</span>
                            `;
                        }
                        
                        return `<div class="slot-cell ${slotInfo.class}${slotInfo.optimistic ? ' optimistic' : ''}" onclick="toggleSlot(${dayIndex}, ${timeIndex}, event)">${content}</div>`;
                    }).join('')}
                </div>
            `).join('');
            
            document.getElementById('dayHeader').innerHTML = dayHeaderHtml;
            document.getElementById('timeTable').innerHTML = tableHtml;
        }

        function getSlotInfo(dayIndex, timeIndex) {
            const timeSlots = getCurrentTimeSlots();
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = formatDate(date);
            const startTime = timeSlots[timeIndex];
            const weekKey = getWeekKey(currentWeekStart);
            
            const endTimeInfo = calculateEndTimeAndDate(dateStr, startTime, 60);
            const endTime = endTimeInfo.endTime;
            
            if (pendingChanges[weekKey]) {
                const pending = pendingChanges[weekKey].find(p => 
                    p.date === dateStr && p.startTime === startTime && p.endTime === endTime
                );
                
                if (pending) {
                    if (pending.action === 'add') {
                        const calEvent = calendarData[weekKey]?.find(e =>
                            e.date === dateStr && e.startTime === startTime && e.endTime === endTime && e.optimistic
                        );
                        
                        if (calEvent) {
                            return { class: 'confirmed', optimistic: true };
                        } else {
                            return { class: 'pending' };
                        }
                    } else if (pending.action === 'delete') {
                        return { class: '' };
                    }
                }
            }
            
            if (calendarData[weekKey]) {
                const calEvent = calendarData[weekKey].find(e => 
                    e && e.date === dateStr && e.startTime === startTime && e.endTime === endTime
                );
                
                if (calEvent) {
                    if (calEvent.status === 'booked') return { 
                        class: 'booked', 
                        studentName: calEvent.studentName || calEvent.memberName || ''
                    };
                    if (calEvent.status === 'reserved') return { 
                        class: 'reserved', 
                        studentName: calEvent.studentName || calEvent.memberName || ''
                    };
                    if (calEvent.status === 'available' && !calEvent.optimistic) return { 
                        class: 'confirmed'
                    };
                    if (calEvent.status === 'available' && calEvent.optimistic) return {
                        class: 'confirmed',
                        optimistic: true
                    };
                }
            }
            
            return { class: '' };
        }

        function toggleViewMode() {
            if (viewMode === 'simple') {
                viewMode = 'detail';
                document.getElementById('viewModeBtn').innerHTML = 'âš¡ ç°¡æ˜“æ¨¡å¼';
                document.getElementById('viewModeDesc').textContent = 'åˆ‡æ›åªé¸"æ•´é»"æ™‚æ®µ';
                showToast('ğŸ¯ è©³ç´°æ¨¡å¼');
            } else {
                viewMode = 'simple';
                document.getElementById('viewModeBtn').innerHTML = 'ğŸ¯ è©³ç´°æ¨¡å¼';
                document.getElementById('viewModeDesc').textContent = 'åˆ‡æ›å¯é¸15/30/45åˆ†';
                showToast('âš¡ ç°¡æ˜“æ¨¡å¼');
            }
            generateCalendar();
            updateStats();
            updateSaveStatus();
        }

        function getCurrentTimeSlots() {
            return viewMode === 'simple' ? timeSlotsSimple : timeSlotsDetail;
        }

        // âœ… ä¿®å¾©ç‰ˆ toggleSlot - é˜²æ­¢å¿«é€Ÿé»æ“Šé€ æˆé‡è¤‡
        function toggleSlot(dayIndex, timeIndex, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // âœ… é˜²æ­¢å¿«é€Ÿé»æ“Š
            if (isToggling) {
                console.log('â³ æ“ä½œä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            isToggling = true;
            setTimeout(() => { isToggling = false; }, 300);  // 300ms é˜²æŠ–
            
            const timeSlots = getCurrentTimeSlots();
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = formatDate(date);
            const startTime = timeSlots[timeIndex];
            
            const durationMinutes = 60;
            const endTimeInfo = calculateEndTimeAndDate(dateStr, startTime, durationMinutes);
            const endTime = endTimeInfo.endTime;
            
            if (endTimeInfo.isCrossDay) {
                console.log(`â° è·¨æ—¥æ™‚æ®µ: ${dateStr} ${startTime} â†’ ${endTimeInfo.endDate} ${endTime}`);
            }
            
            const weekKey = getWeekKey(currentWeekStart);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºå·²é ç´„/ä¿ç•™çš„æ™‚æ®µ
            if (calendarData[weekKey]) {
                const existingEvent = calendarData[weekKey].find(e => 
                    e && e.date === dateStr && e.startTime === startTime && e.endTime === endTime
                );
                
                if (existingEvent && (existingEvent.status === 'booked' || existingEvent.status === 'reserved')) {
                    showToast('âŒ æ­¤æ™‚æ®µç„¡æ³•ä¿®æ”¹');
                    return;
                }
            }
            
            if (!pendingChanges[weekKey]) pendingChanges[weekKey] = [];
            
            // âœ… ä¿®å¾©ï¼šåŒæ™‚æª¢æŸ¥ optimistic å’Œé optimistic
            const existsInCalendar = calendarData[weekKey] && calendarData[weekKey].some(e => 
                e && e.date === dateStr && e.startTime === startTime && e.endTime === endTime && 
                e.status === 'available' && !e.optimistic
            );
            
            const existsOptimistic = calendarData[weekKey] && calendarData[weekKey].some(e =>
                e && e.date === dateStr && e.startTime === startTime && e.endTime === endTime &&
                e.status === 'available' && e.optimistic
            );
            
            const pendingIndex = pendingChanges[weekKey].findIndex(p => 
                p.date === dateStr && p.startTime === startTime && p.endTime === endTime
            );
            
            if (pendingIndex >= 0) {
                const pendingAction = pendingChanges[weekKey][pendingIndex].action;
                pendingChanges[weekKey].splice(pendingIndex, 1);
                
                if (pendingAction === 'add') {
                    const eventIndex = calendarData[weekKey]?.findIndex(e =>
                        e.date === dateStr && e.startTime === startTime && e.endTime === endTime && e.optimistic
                    );
                    if (eventIndex >= 0) {
                        calendarData[weekKey].splice(eventIndex, 1);
                    }
                }
                
                showToast(`âŒ å·²å–æ¶ˆ ${startTime}-${endTime}`);
            }
            else if (existsInCalendar) {
                const calEvent = calendarData[weekKey].find(e =>
                    e.date === dateStr && e.startTime === startTime && e.endTime === endTime
                );
                
                pendingChanges[weekKey].push({
                    action: 'delete',
                    date: dateStr,
                    startTime,
                    endTime,
                    endDate: endTimeInfo.endDate,
                    isCrossDay: endTimeInfo.isCrossDay,
                    dayIndex,
                    dayLabel: dayLabels[dayIndex],
                    duration: durationMinutes,
                    eventId: calEvent ? calEvent.eventId : null
                });
                
                showToast(`ğŸ“ å·²æ¨™è¨˜åˆªé™¤ ${startTime}-${endTime}`);
            }
            else if (existsOptimistic) {
                // âœ… æ–°å¢ï¼šå¦‚æœå·²ç¶“æœ‰ optimisticï¼Œå°±å–æ¶ˆå®ƒ
                const eventIndex = calendarData[weekKey]?.findIndex(e =>
                    e.date === dateStr && e.startTime === startTime && e.endTime === endTime && e.optimistic
                );
                if (eventIndex >= 0) {
                    calendarData[weekKey].splice(eventIndex, 1);
                }
                
                // æ‰¾åˆ°å°æ‡‰çš„ pending ä¸¦ç§»é™¤
                const pendingIdx = pendingChanges[weekKey].findIndex(p =>
                    p.date === dateStr && p.startTime === startTime && p.endTime === endTime && p.action === 'add'
                );
                if (pendingIdx >= 0) {
                    pendingChanges[weekKey].splice(pendingIdx, 1);
                }
                
                showToast(`âŒ å·²å–æ¶ˆ ${startTime}-${endTime}`);
            }
            else {
                if (!calendarData[weekKey]) calendarData[weekKey] = [];
                
                const tempEventId = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                calendarData[weekKey].push({
                    date: dateStr,
                    startTime,
                    endTime,
                    status: 'available',
                    eventId: tempEventId,
                    optimistic: true
                });
                
                pendingChanges[weekKey].push({
                    action: 'add',
                    date: dateStr,
                    startTime,
                    endTime,
                    endDate: endTimeInfo.endDate,
                    isCrossDay: endTimeInfo.isCrossDay,
                    dayIndex,
                    dayLabel: dayLabels[dayIndex],
                    duration: durationMinutes,
                    tempEventId: tempEventId
                });
                
                showToast(`âœ… å·²æ–°å¢ ${startTime}-${endTime} (å¾…é€å‡º)${endTimeInfo.isCrossDay ? ' (è·¨æ—¥)' : ''}`);
            }
            
            generateCalendar();
            updateStats();
            updateSaveStatus();
        }

        // âœ… ä¿®å¾©ç‰ˆ showSaveModal - åŠ å…¥å»é‡é¡¯ç¤º
        function showSaveModal() {
            const allChangesRaw = [];
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey] && pendingChanges[weekKey].length > 0) {
                    allChangesRaw.push(...pendingChanges[weekKey]);
                }
            });
            
            if (allChangesRaw.length === 0) {
                showToast('â„¹ï¸ æ²’æœ‰éœ€è¦é€å‡ºçš„è®Šæ›´');
                return;
            }
            
            // âœ… å»é‡
            const seenKeys = new Set();
            const allChanges = [];
            
            allChangesRaw.forEach(change => {
                const key = `${change.action}_${change.date}_${change.startTime}_${change.endTime}`;
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    allChanges.push(change);
                }
            });
            
            const added = allChanges.filter(c => c.action === 'add');
            const deleted = allChanges.filter(c => c.action === 'delete');
            
            document.getElementById('modalAddCount').textContent = added.length;
            document.getElementById('modalDeleteCount').textContent = deleted.length;
            document.getElementById('modalTotalCount').textContent = allChanges.length;
            
            const changesList = [...added, ...deleted].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            document.getElementById('confirmScheduleList').innerHTML = changesList.map(c => `
                <div class="schedule-item ${c.action}">
                    <div><div class="schedule-date">${c.date} (${c.dayLabel})</div></div>
                    <div class="schedule-time">${c.startTime} - ${c.endTime}</div>
                </div>
            `).join('');
            
            document.getElementById('saveModalOverlay').classList.remove('hidden');
        }

        function hideSaveModal() {
            document.getElementById('saveModalOverlay').classList.add('hidden');
        }

        function showWeekJumpModal() {
            document.getElementById('jumpToDate').value = formatDate(currentWeekStart);
            document.getElementById('weekJumpModalOverlay').classList.remove('hidden');
        }

        function hideWeekJumpModal() {
            document.getElementById('weekJumpModalOverlay').classList.add('hidden');
        }

        function confirmWeekJump() {
            const dateInput = document.getElementById('jumpToDate').value;
            if (!dateInput) {
                showToast('âš ï¸ è«‹é¸æ“‡æ—¥æœŸ');
                return;
            }

            const selectedDate = new Date(dateInput + 'T00:00:00');
            const dayOfWeek = selectedDate.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            
            const weekStart = new Date(selectedDate);
            weekStart.setDate(selectedDate.getDate() + diff);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            currentWeekStart = weekStart;
            currentWeekEnd = weekEnd;
            
            hideWeekJumpModal();
            updateWeekDisplay();
            generateCalendar();
            updateStats();
            updateSaveStatus();
            showToast(`ğŸ“… å·²è·³è½‰è‡³ ${formatDate(weekStart)}`);
        }

        // âœ… ä¿®å¾©ç‰ˆ confirmSave - åŠ å…¥å»é‡é‚è¼¯
        async function confirmSave() {
            if (isSaving) {
                showToast('âš ï¸ æ­£åœ¨é€å‡ºä¸­,è«‹ç¨å€™...');
                return;
            }
            
            // âœ… æ”¶é›†æ‰€æœ‰è®Šæ›´
            const allChangesRaw = [];
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey] && pendingChanges[weekKey].length > 0) {
                    allChangesRaw.push(...pendingChanges[weekKey]);
                }
            });
            
            if (allChangesRaw.length === 0) {
                hideSaveModal();
                return;
            }
            
            // âœ… é—œéµä¿®å¾©ï¼šå»é‡é‚è¼¯
            const seenKeys = new Set();
            const allChanges = [];
            
            allChangesRaw.forEach(change => {
                // å»ºç«‹å”¯ä¸€ keyï¼šaction + date + startTime + endTime
                const key = `${change.action}_${change.date}_${change.startTime}_${change.endTime}`;
                
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    allChanges.push(change);
                } else {
                    console.warn('âš ï¸ è·³éé‡è¤‡é …ç›®:', key);
                }
            });
            
            console.log(`ğŸ“Š å»é‡å‰: ${allChangesRaw.length} é …, å»é‡å¾Œ: ${allChanges.length} é …`);
            
            if (allChanges.length === 0) {
                hideSaveModal();
                showToast('â„¹ï¸ æ²’æœ‰éœ€è¦é€å‡ºçš„è®Šæ›´');
                return;
            }
            
            const deleteChanges = allChanges.filter(c => c.action === 'delete');
            const missingEventIds = deleteChanges.filter(c => !c.eventId);
            
            if (missingEventIds.length > 0) {
                console.warn('âš ï¸ ä»¥ä¸‹åˆªé™¤æ“ä½œç¼ºå°‘ eventId:', missingEventIds);
            }
            
            isSaving = true;
            
            const confirmBtn = document.getElementById('confirmSaveBtn');
            const originalText = confirmBtn ? confirmBtn.textContent : 'ç¢ºèªé€å‡º';
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
                confirmBtn.style.cursor = 'not-allowed';
                confirmBtn.textContent = 'é€å‡ºä¸­...';
            }
            
            hideSaveModal();
            showToast(`ğŸ“¤ é€å‡º ${allChanges.length} å€‹æ™‚æ®µ...`);
            
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save',
                        userId: currentTeacher,
                        userName: currentTeacher,
                        coachType: currentTeacherType,
                        timestamp: new Date().toISOString(),
                        changes: allChanges.map(c => {
                            const endTimeInfo = calculateEndTimeAndDate(c.date, c.startTime, c.duration || 60);
                            
                            return {
                                action: c.action,
                                date: c.date,
                                startTime: c.startTime,
                                endTime: endTimeInfo.endTime,
                                endDate: endTimeInfo.endDate,
                                isCrossDay: endTimeInfo.isCrossDay,
                                dayName: c.dayLabel,
                                startDateTime: `${c.date} ${c.startTime}`,
                                endDateTime: endTimeInfo.endDateTime,
                                eventId: c.eventId || null
                            };
                        })
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… é€å‡ºæˆåŠŸ');
                    
                    pendingChanges = {};
                    await loadFromCalendar();
                    generateCalendar();
                    updateStats();
                    updateSaveStatus();
                    
                    showToast(`ğŸ‰ å·²é€å‡º ${allChanges.length} å€‹æ™‚æ®µ!`);
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('âŒ é€å‡ºéŒ¯èª¤:', error);
                showToast('âŒ é€å‡ºå¤±æ•—,è«‹ç¨å¾Œé‡è©¦', 4000);
                
                if (confirm('é€å‡ºå¤±æ•—,æ˜¯å¦è¦é‡æ–°è¼‰å…¥é é¢ä»¥ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§?')) {
                    location.reload();
                }
            } finally {
                isSaving = false;
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                    confirmBtn.textContent = originalText;
                }
            }
        }

        async function reloadFromCalendar() {
            let totalPending = 0;
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey]) totalPending += pendingChanges[weekKey].length;
            });
            
            let optimisticCount = 0;
            Object.keys(calendarData).forEach(weekKey => {
                if (calendarData[weekKey]) {
                    optimisticCount += calendarData[weekKey].filter(e => e.optimistic).length;
                }
            });
            
            const totalUnsaved = totalPending + optimisticCount;
            
            if (totalUnsaved > 0) {
                if (!confirm(`ç¢ºå®šè¦é‡æ–°è¼‰å…¥å—?æœ‰ ${totalUnsaved} å€‹æœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚`)) {
                    return;
                }
            } else {
                if (!confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥å—?')) {
                    return;
                }
            }
            
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('loadingText').textContent = 'é‡æ–°è¼‰å…¥è³‡æ–™ä¸­...';
            
            calendarData = {};
            pendingChanges = {};
            
            await loadFromCalendar();
            generateCalendar();
            updateStats();
            updateSaveStatus();
            
            document.getElementById('loadingScreen').classList.add('hidden');
            showToast('âœ… é‡æ–°è¼‰å…¥å®Œæˆ');
        }

        function clearCurrentWeek() {
            const weekKey = getWeekKey(currentWeekStart);
            
            let pendingCount = 0;
            if (pendingChanges[weekKey]) {
                pendingCount = pendingChanges[weekKey].length;
            }
            
            let optimisticCount = 0;
            if (calendarData[weekKey]) {
                optimisticCount = calendarData[weekKey].filter(e => e.optimistic).length;
            }
            
            const totalCount = pendingCount + optimisticCount;
            
            if (totalCount === 0) {
                showToast('â„¹ï¸ æœ¬é€±æ²’æœ‰å¾…é€å‡ºçš„è®Šæ›´');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦æ¸…é™¤æœ¬é€± ${totalCount} å€‹å¾…é€å‡ºçš„è®Šæ›´å—?`)) {
                if (pendingChanges[weekKey]) {
                    delete pendingChanges[weekKey];
                }
                
                if (calendarData[weekKey]) {
                    calendarData[weekKey] = calendarData[weekKey].filter(e => !e.optimistic);
                }
                
                generateCalendar();
                updateStats();
                updateSaveStatus();
                showToast(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${totalCount} å€‹è®Šæ›´`);
            }
        }
        
        function clearAllWeeks() {
            let pendingCount = 0;
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey]) pendingCount += pendingChanges[weekKey].length;
            });
            
            let optimisticCount = 0;
            Object.keys(calendarData).forEach(weekKey => {
                if (calendarData[weekKey]) {
                    optimisticCount += calendarData[weekKey].filter(e => e.optimistic).length;
                }
            });
            
            const totalCount = pendingCount + optimisticCount;
            
            if (totalCount === 0) {
                showToast('â„¹ï¸ æ²’æœ‰å¾…é€å‡ºçš„è®Šæ›´');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨ ${totalCount} å€‹å¾…é€å‡ºçš„è®Šæ›´å—?`)) {
                pendingChanges = {};
                
                Object.keys(calendarData).forEach(weekKey => {
                    if (calendarData[weekKey]) {
                        calendarData[weekKey] = calendarData[weekKey].filter(e => !e.optimistic);
                    }
                });
                
                generateCalendar();
                updateStats();
                updateSaveStatus();
                showToast(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${totalCount} å€‹è®Šæ›´`);
            }
        }

        // âœ… ä¿®å¾©ç‰ˆ copyLastWeek - åŒæ™‚æª¢æŸ¥ calendarData å’Œ pendingChanges
        function copyLastWeek() {
            const lastWeekStart = new Date(currentWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekKey = getWeekKey(lastWeekStart);
            
            if (!calendarData[lastWeekKey] || calendarData[lastWeekKey].length === 0) {
                showToast('âŒ ä¸Šé€±æ²’æœ‰æ’ç¨‹è³‡æ–™');
                return;
            }
            
            const currentWeekKey = getWeekKey(currentWeekStart);
            if (!pendingChanges[currentWeekKey]) pendingChanges[currentWeekKey] = [];
            if (!calendarData[currentWeekKey]) calendarData[currentWeekKey] = [];
            
            let copiedCount = 0;
            let skippedCount = 0;
            
            calendarData[lastWeekKey].forEach(event => {
                if (event && event.status === 'available' && !event.optimistic) {
                    const lastWeekDate = new Date(event.date + 'T00:00:00');
                    const currentWeekDate = new Date(lastWeekDate);
                    currentWeekDate.setDate(currentWeekDate.getDate() + 7);
                    const newDateStr = formatDate(currentWeekDate);
                    
                    // âœ… ä¿®å¾©ï¼šåŒæ™‚æª¢æŸ¥ calendarData å’Œ pendingChanges
                    const existsInCalendar = calendarData[currentWeekKey].some(e => 
                        e.date === newDateStr && e.startTime === event.startTime && e.endTime === event.endTime
                    );
                    
                    const existsInPending = pendingChanges[currentWeekKey].some(p =>
                        p.date === newDateStr && p.startTime === event.startTime && p.endTime === event.endTime
                    );
                    
                    if (existsInCalendar || existsInPending) {
                        skippedCount++;
                        console.log(`â­ï¸ è·³éå·²å­˜åœ¨: ${newDateStr} ${event.startTime}`);
                        return;
                    }
                    
                    const dayIndex = currentWeekDate.getDay() === 0 ? 6 : currentWeekDate.getDay() - 1;
                    const tempEventId = `temp-${Date.now()}-${copiedCount}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    calendarData[currentWeekKey].push({
                        date: newDateStr,
                        startTime: event.startTime,
                        endTime: event.endTime,
                        status: 'available',
                        eventId: tempEventId,
                        optimistic: true
                    });
                    
                    pendingChanges[currentWeekKey].push({
                        action: 'add',
                        date: newDateStr,
                        startTime: event.startTime,
                        endTime: event.endTime,
                        dayIndex,
                        dayLabel: dayLabels[dayIndex],
                        tempEventId: tempEventId
                    });
                    
                    copiedCount++;
                }
            });
            
            generateCalendar();
            updateStats();
            updateSaveStatus();
            
            if (skippedCount > 0) {
                showToast(`ğŸ“‹ è¤‡è£½ ${copiedCount} å€‹æ™‚æ®µ (è·³é ${skippedCount} å€‹é‡è¤‡)`);
            } else {
                showToast(`ğŸ“‹ å·²è¤‡è£½ ${copiedCount} å€‹æ™‚æ®µ (å¾…é€å‡º)`);
            }
        }

        function previousWeek() {
            const weekDiff = Math.round((currentWeekStart - baseWeekStart) / (7 * 24 * 60 * 60 * 1000));
            if (weekDiff + 1 <= 1) {
                showToast('âš ï¸ å·²ç¶“æ˜¯æœ¬é€±äº†');
                return;
            }
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() - 7);
            updateWeekDisplay();
            generateCalendar();
            updateStats();
            updateSaveStatus();
        }

        function nextWeek() {
            const weekDiff = Math.round((currentWeekStart - baseWeekStart) / (7 * 24 * 60 * 60 * 1000));
            if (weekDiff + 1 >= PRELOAD_WEEKS) {
                showToast(`âš ï¸ æœ€å¤š${PRELOAD_WEEKS}é€±`);
                return;
            }
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            currentWeekEnd.setDate(currentWeekEnd.getDate() + 7);
            updateWeekDisplay();
            generateCalendar();
            updateStats();
            updateSaveStatus();
        }

        function getUserInfo() {
            const params = new URLSearchParams(window.location.search);
            currentTeacher = params.get('userId') || params.get('teacher') || params.get('coach') || 'test-coach';
            currentTeacherType = params.get('type') || 'pilates';
            document.getElementById('userName').textContent = currentTeacher;
            document.getElementById('userType').textContent = currentTeacherType;
            document.getElementById('userAvatar').textContent = getCoachTypeIcon(currentTeacherType);
        }
        
        function getCoachTypeIcon(type) {
            const typeMap = {
                'ai_analysis': 'ğŸ¤–',
                'aianalysis': 'ğŸ¤–',
                'pilates': 'ğŸ§˜',
                'strength_training': 'ğŸ’ª',
                'strengthtraining': 'ğŸ’ª',
                'stretching': 'ğŸ¤¸',
                'AIåˆ†æ': 'ğŸ¤–',
                'aiåˆ†æ': 'ğŸ¤–',
                'çš®æ‹‰ææ–¯': 'ğŸ§˜',
                'é‡è¨“': 'ğŸ’ª',
                'ä¼¸å±•': 'ğŸ¤¸'
            };
            
            if (typeMap[type]) return typeMap[type];
            
            const normalized = type.toLowerCase().replace(/_/g, '');
            return typeMap[normalized] || 'ğŸ‘¤';
        }

        function setCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diff);
            currentWeekStart.setHours(0, 0, 0, 0);
            currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
            baseWeekStart = new Date(currentWeekStart);
        }

        function updateWeekDisplay() {
            const weekDiff = Math.round((currentWeekStart - baseWeekStart) / (7 * 24 * 60 * 60 * 1000));
            const year = currentWeekStart.getFullYear();
            document.getElementById('weekDisplay').textContent = `${year}å¹´ ç¬¬ ${weekDiff + 1} é€±`;
            document.getElementById('weekRange').textContent = `${formatDateShort(currentWeekStart)} - ${formatDateShort(currentWeekEnd)}`;
        }

        function getWeekKey(date) {
            return `${date.getFullYear()}-W${String(getWeekNumber(date)).padStart(2, '0')}`;
        }

        function getWeekKeyFromDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return getWeekKey(date);
        }

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatDateShort(date) {
            return `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        window.addEventListener('DOMContentLoaded', init);
        
        window.addEventListener('beforeunload', function(e) {
            let totalPending = 0;
            Object.keys(pendingChanges).forEach(weekKey => {
                if (pendingChanges[weekKey]) totalPending += pendingChanges[weekKey].length;
            });
            
            let optimisticCount = 0;
            Object.keys(calendarData).forEach(weekKey => {
                if (calendarData[weekKey]) {
                    optimisticCount += calendarData[weekKey].filter(e => e.optimistic).length;
                }
            });
            
            const totalUnsaved = totalPending + optimisticCount;
            
            if (totalUnsaved > 0) {
                const message = `æ‚¨æœ‰ ${totalUnsaved} å€‹æœªé€å‡ºçš„è®Šæ›´,ç¢ºå®šè¦é›¢é–‹å—?`;
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });
    </script>
</body>
</html>
